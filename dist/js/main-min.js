var vm;window.onload=function(){vm=new Vue({el:"#v-app",data:{gamesListOffset:13e3,totalNumberOfGames:null,randomGameSet:null,randomGameCategories:null,gameID:null,gameTitle:null,categoryID:null,categoryName:null,weblink:null,runTime:null,primaryTimingMethod:null,players:[],videoType:null,videoID:null,displayObj:{gameTitle:null,categoryName:null,weblink:null,runTime:null,primaryTimingMethod:null,players:[],videoType:null,videoID:null,embedSource:null},categoryInfoFlag:!1,playerInfoFlags:[!1,!1,!1,!1],isButtonDisabled:!0},methods:{fetchNewRecord:function(){this.disableButton(),this.resetRecordData(),this.getRandomGameSet()},getTotalNumberOfGames:function(){var e=new XMLHttpRequest;e.open("GET","https://www.speedrun.com/api/v1/games?_bulk=yes&max=1000&offset="+this.gamesListOffset,!0),e.onload=function(){var e=JSON.parse(this.responseText);1e3===e.pagination.size?(vm.gamesListOffset+=1e3,vm.getTotalNumberOfGames()):vm.totalNumberOfGames=vm.gamesListOffset+e.pagination.size,vm.checkForURIHash()},e.send(null)},checkForURIHash:function(){window.location.hash?(this.parseURIFragments(),this.getRecordFromFragments()):this.getRandomGameSet()},getRandomGameSet:function(){var e=Math.floor(Math.random()*(this.totalNumberOfGames-19)),t=new XMLHttpRequest;t.open("GET","https://www.speedrun.com/api/v1/games?offset="+e,!0),t.onload=function(){vm.randomGameSet=JSON.parse(this.responseText).data,vm.selectGameFromSet()},t.send(null)},selectGameFromSet(){var e=Math.floor(Math.random()*this.randomGameSet.length),t=this.randomGameSet[e];this.gameID=t.id,this.gameTitle=t.names.international?t.names.international:t.names.japanese,this.randomGameSet.splice(e,1),this.getRecordsFromGameID(this.gameID)},getRecordsFromGameID:function(e){var t=new XMLHttpRequest;t.open("GET","https://www.speedrun.com/api/v1/games/"+this.gameID+"/records?top=1&scope=full-game&skip-empty=true",!0),t.onload=function(){vm.randomGameCategories=JSON.parse(this.responseText).data,vm.selectCategoryFromSet()},t.send(null)},selectCategoryFromSet:function(){if(this.randomGameCategories.length){var e=Math.floor(Math.random()*this.randomGameCategories.length),t=this.randomGameCategories[e].runs[0].run;if(this.randomGameCategories.splice(e,1),t.videos&&/\/v(?:ideos)?\/([^&]+)|(?:v=|\.be\/)([^&]+)/.test(t.videos.links[0].uri)){this.saveRecordInfo(t),this.randomGameSet=[],this.randomGameCategories=[],this.getCategoryInfoFromID(this.categoryID);for(var i=0;i<this.players.length;i++)this.getPlayerInfoFromURI(i);for(i=this.players.length;i<4;i++)this.playerInfoFlags[i]=!0}else this.selectCategoryFromSet()}else this.selectGameFromSet()},saveRecordInfo:function(e){this.categoryID=e.category,this.runTime=e.times.primary,this.runTime===e.times.ingame?this.primaryTimingMethod="IGT":this.runTime===e.times.realtime?this.primaryTimingMethod="RTA":this.primaryTimingMethod="RTA (No Loads)";for(var t=0;t<e.players.length;t++)this.players[t]=e.players[t];e.videos.links[0].uri.includes("twitch.tv")?(this.videoType="twitch",this.videoID=/\/v(?:ideos)?\/([^&]+)/.exec(e.videos.links[0].uri)[1]):(this.videoType="youtube",this.videoID=/(?:v=|\.be\/)([^&]+)/.exec(e.videos.links[0].uri)[1])},getCategoryInfoFromID:function(e){var t=new XMLHttpRequest;t.open("GET","https://www.speedrun.com/api/v1/categories/"+e,!0),t.onload=function(){var e=JSON.parse(this.responseText).data;vm.categoryName=e.name,vm.weblink=e.weblink,vm.categoryInfoFlag=!0,vm.infoReadyToDisplay()&&(vm.updateURIFragments(),vm.populateDisplayObj(),vm.enableButton())},t.send(null)},getPlayerInfoFromURI:function(e){if(this.players[e].weblink=null,this.players[e].twitch=null,this.players[e].youtube=null,this.players[e].twitter=null,"user"===this.players[e].rel){var t=new XMLHttpRequest;t.open("GET",this.players[e].uri,!0),t.onload=function(){var t=JSON.parse(this.responseText).data;vm.players[e].weblink=t.weblink,vm.players[e].name=vm.players[e].weblink.match(/([^\/]*)$/)[0],vm.players[e].twitch=t.twitch?t.twitch.uri:null,vm.players[e].youtube=t.youtube?t.youtube.uri:null,vm.players[e].twitter=t.twitter?t.twitter.uri:null,vm.playerInfoFlags[e]=!0,vm.infoReadyToDisplay()&&(vm.updateURIFragments(),vm.populateDisplayObj(),vm.enableButton())},t.send(null)}else this.playerInfoFlags[e]=!0,this.infoReadyToDisplay()&&(this.populateDisplayObj(),this.updateHistory(),this.enableButton())},infoReadyToDisplay:function(){return this.categoryInfoFlag&&this.playerInfoFlags[0]&&this.playerInfoFlags[1]&&this.playerInfoFlags[2]&&this.playerInfoFlags[3]},populateDisplayObj:function(){this.resetDisplayObj(),this.resetDisplayFlags(),this.displayObj.gameTitle=this.gameTitle+" - ",this.displayObj.categoryName=this.categoryName,this.displayObj.weblink=this.weblink,this.displayObj.runTime=this.formatRunTime(this.runTime),this.displayObj.primaryTimingMethod="("+this.primaryTimingMethod+")",this.displayObj.players=this.players,this.displayObj.videoType=this.videoType,this.displayObj.videoID=this.videoID,this.displayObj.embedSource=this.generateEmbedSource(this.videoType,this.videoID)},formatRunTime:function(e){(e=e.slice(2)).includes("M")&&!e.includes("S")&&(e+="0S"),e=e.match(/[\d\.]+/g);for(var t=0;t<e.length;t++)3===e.length&&0===t||e[t]<10&&(e[t]="0"+e[t]);return 1===e.length&&e.unshift(0),"in "+(e=e.join(":"))},generateEmbedSource:function(e,t){return"youtube"===e?"https://www.youtube.com/embed/"+t:"https://player.twitch.tv/?video="+t},enableButton:function(){this.isButtonDisabled=!1},disableButton:function(){this.isButtonDisabled=!0},resetRecordData:function(){this.gameID=null,this.gameTitle=null,this.categoryID=null,this.categoryName=null,this.weblink=null,this.runTime=null,this.primaryTimingMethod=null,this.players=[],this.videoType=null,this.videoID=null},resetDisplayObj:function(){this.displayObj.gameTitle=null,this.displayObj.categoryName=null,this.displayObj.weblink=null,this.displayObj.runTime=null,this.displayObj.primaryTimingMethod=null,this.displayObj.players=[],this.displayObj.videoType=null,this.displayObj.videoID=null,this.displayObj.embedSource=null},resetDisplayFlags:function(){this.categoryInfoFlag=!1,this.playerInfoFlags=[!1,!1,!1,!1]},updateURIFragments:function(){var e=[this.categoryID,this.gameID,this.gameTitle];e=encodeURI(e.join(",")),location.hash=e},parseURIFragments:function(){hash=decodeURI(window.location.hash).slice(1).split(","),this.categoryID=hash[0],this.gameID=hash[1],this.gameTitle=hash[2]},getRecordFromFragments:function(){this.getRecordFromCategoryID(this.categoryID),this.getCategoryInfoFromCategoryID(this.categoryID)},getRecordFromCategoryID:function(e){var t=new XMLHttpRequest;t.open("GET","https://www.speedrun.com/api/v1/categories/"+e+"/records?top=1",!0),t.onload=function(){vm.saveRecordInfo(JSON.parse(this.responseText).data[0].runs[0].run);for(var e=0;e<vm.players.length;e++)vm.getPlayerInfoFromURI(e);for(e=vm.players.length;e<4;e++)vm.playerInfoFlags[e]=!0;vm.infoReadyToDisplay()&&(vm.populateDisplayObj(),vm.enableButton())},t.send(null)},getCategoryInfoFromCategoryID:function(e){var t=new XMLHttpRequest;t.open("GET","https://www.speedrun.com/api/v1/categories/"+e,!0),t.onload=function(){var e=JSON.parse(this.responseText).data;vm.categoryName=e.name,vm.weblink=e.weblink,vm.categoryInfoFlag=!0,vm.infoReadyToDisplay()&&(vm.populateDisplayObj(),vm.enableButton())},t.send(null)}},mounted:function(){this.getTotalNumberOfGames(),window.addEventListener("keyup",function(e){32===e.which&&vm.fetchNewRecord()})}})};